<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Issue Refund Ticket</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <h1>Issue Refund Ticket</h1>
  <div class="card">
    <form id="issueForm">
      <label for="employee_id">Employee ID</label>
      <input id="employee_id" name="employee_id" placeholder="Emp# 045" title="Employee identifier (e.g., Emp# 045)" required>

      <label for="cans_qty">Cans (qty)</label>
      <input id="cans_qty" name="cans_qty" type="number" min="0" value="0" placeholder="0" title="Number of cans">
      <label for="cans_unit">Cans unit value</label>
      <input id="cans_unit" name="cans_unit" type="number" step="0.01" value="0.10" placeholder="0.10" title="Unit value for a single can in dollars">

      <label for="plastic_qty">Plastic bottles (qty)</label>
      <input id="plastic_qty" name="plastic_qty" type="number" min="0" value="0" placeholder="0" title="Number of plastic bottles">
      <label for="plastic_unit">Plastic unit value</label>
      <input id="plastic_unit" name="plastic_unit" type="number" step="0.01" value="0.20" placeholder="0.20" title="Unit value for a single plastic bottle in dollars">

      <label for="glass_qty">Glass bottles (qty)</label>
      <input id="glass_qty" name="glass_qty" type="number" min="0" value="0" placeholder="0" title="Number of glass bottles">
      <label for="glass_unit">Glass unit value</label>
      <input id="glass_unit" name="glass_unit" type="number" step="0.01" value="0.25" placeholder="0.25" title="Unit value for a single glass bottle in dollars">

      <label for="expires_days">Expires (days from now, optional)</label>
      <input id="expires_days" name="expires_days" type="number" min="0" value="90" placeholder="90" title="Days until ticket expires">

      <button type="submit">Create Ticket</button>
    </form>
  </div>

  <div class="card" id="result" hidden>
    <h2>Ticket Issued</h2>
    <div id="ticketInfo"></div>
    <p>QR Code:</p>
    <img id="qr" alt="QR code">
    <p class="code" id="payload"></p>
  </div>

  <footer>Use a USB barcode/QR scanner or copy-paste the code into the Redeem page.</footer>

<script>
  const form = document.getElementById('issueForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = new FormData(form);
    const payload = {
      employee_id: data.get('employee_id'),
      items: [
        { type: 'Cans', qty: parseInt(data.get('cans_qty')||'0'), unit: parseFloat(data.get('cans_unit')||'0') },
        { type: 'Plastic bottles', qty: parseInt(data.get('plastic_qty')||'0'), unit: parseFloat(data.get('plastic_unit')||'0') },
        { type: 'Glass bottles', qty: parseInt(data.get('glass_qty')||'0'), unit: parseFloat(data.get('glass_unit')||'0') }
      ],
      expires_days: parseInt(data.get('expires_days')||'0')
    };
    const res = await fetch('/api/tickets', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    const result = document.getElementById('result');
    result.hidden = false;
    document.getElementById('ticketInfo').innerHTML = `
      <div><strong>Ticket ID:</strong> ${json.id}</div>
      <div><strong>Total:</strong> $${json.total_amount.toFixed(2)}</div>
      <div><strong>Status:</strong> ${json.status}</div>
    `;
    document.getElementById('qr').src = '/api/qr/'+encodeURIComponent(json.id)+'.png';
    document.getElementById('payload').innerText = json.payload;
  });
</script>
</body>
</html>
